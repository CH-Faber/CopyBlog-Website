---
import BaseLayout from "@/layouts/BaseLayout.astro"
import ArticleContent from "@/components/ArticleContent.astro"
import { Header } from "@/components/header"
import { Footer } from "@/components/footer"
import { getPostsWithNav, type PostEntry } from "@/lib/posts"
import Disclaimer from "@/components/Disclaimer.astro"
import PasswordProtection from "@/components/PasswordProtection.astro"
import Comments from "@/components/Comments.astro"
import bcrypt from "bcryptjs"
import CryptoJS from "crypto-js"

export async function getStaticPaths() {
  const posts = await getPostsWithNav()
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

const { post } = Astro.props as { post: PostEntry }

if (!post) {
  return Astro.redirect("/")
}

const { Content, remarkPluginFrontmatter } = await post.render()
const words = remarkPluginFrontmatter?.words
const minutes = remarkPluginFrontmatter?.minutes

const normalizeText = (text: string) => text.replace(/\s+/g, " ").trim()
const buildMetaDescription = (primary: string, fallback: string, title: string, encrypted: boolean) => {
  const preferred = normalizeText(primary)
  const backup = normalizeText(fallback)

  let result = preferred
  if (!result || result.length < 60) {
    result = backup
  }
  if (!result || result.length < 60) {
    result = encrypted ? `${title}｜此文章已加密，输入密码后阅读。` : title
  }
  return result.length > 160 ? result.slice(0, 160) : result
}

const description = buildMetaDescription(
  post.data.description || "",
  remarkPluginFrontmatter?.excerpt || "",
  post.data.title,
  post.data.encrypted ?? false,
)
const title = `${post.data.title} | 时歌的博客`

let encryptedData = null
if (post.data.encrypted && post.data.password) {
  const passwordHash = bcrypt.hashSync(post.data.password, 10)
  const body = typeof post.body === "string" ? post.body : String(post.body || "")
  const encrypted = CryptoJS.AES.encrypt(body, post.data.password).toString()
  encryptedData = {
    content: encrypted,
    hash: passwordHash,
  }
}
---

<BaseLayout {title} {description}>
  <div class="min-h-screen bg-background dark:bg-muted/30">
    <Header client:load />
    <ArticleContent post={post} {Content} {words} {minutes}>
      <div class="mb-8">
        <Disclaimer disclaimers={post.data.disclaimer} publishedDate={post.data.published} />
      </div>
      {encryptedData ? (
        <div class="mb-6">
          <PasswordProtection encryptedData={encryptedData} slug={post.slug} class="mb-6 rounded-xl" />
          <div id={`article-content-${post.slug}`} class="mb-6 hidden encrypted-content">
            <!-- 内容将在验证密码后动态插入 -->
          </div>
        </div>
      ) : (
        <Content />
      )}
    </ArticleContent>
    <Comments />
    <Footer />
  </div>
</BaseLayout>
