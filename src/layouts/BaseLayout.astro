---
import "@/styles/global.css"
import { ViewTransitions } from "astro:transitions"

interface Props {
  title?: string
  description?: string
  canonical?: string
  ogType?: string
  ogTitle?: string
  ogDescription?: string
  ogUrl?: string
  twitterCard?: string
  twitterTitle?: string
  twitterDescription?: string
  robots?: string
}

const defaultTitle = "时歌的博客 | Boundary of Thought"
const defaultDescription = "探索金融、社会与人工智能的交汇点"

const {
  title = defaultTitle,
  description = defaultDescription,
  canonical,
  ogType = "website",
  ogTitle,
  ogDescription,
  ogUrl,
  twitterCard = "summary",
  twitterTitle,
  twitterDescription,
  robots,
} = Astro.props as Props

const canonicalUrl = canonical || Astro.url.toString()
const resolvedOgTitle = ogTitle || title
const resolvedOgDescription = ogDescription || description
const resolvedOgUrl = ogUrl || canonicalUrl
const resolvedTwitterTitle = twitterTitle || title
const resolvedTwitterDescription = twitterDescription || description
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {robots ? <meta name="robots" content={robots} /> : null}
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={resolvedOgTitle} />
    <meta property="og:description" content={resolvedOgDescription} />
    <meta property="og:url" content={resolvedOgUrl} />
    <meta property="og:site_name" content="时歌的博客" />
    <meta property="og:locale" content="zh_CN" />
    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:title" content={resolvedTwitterTitle} />
    <meta name="twitter:description" content={resolvedTwitterDescription} />
    <slot name="head" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="icon" href="/icon-light-32x32.png" media="(prefers-color-scheme: light)" />
    <link rel="icon" href="/icon-dark-32x32.png" media="(prefers-color-scheme: dark)" />
    <link rel="icon" href="/icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-icon.png" />
    <!-- Google tag (gtag.js) -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-1DF2LNJPSY"></script>
    <script is:inline>
      // @ts-nocheck
      window.dataLayer = window.dataLayer || []
      const gtag = (...args) => {
        window.dataLayer.push(args)
      }
      gtag('js', new Date())
      gtag('config', 'G-1DF2LNJPSY')
    </script>

    <!-- Microsoft Clarity -->
    <script is:inline>
      // @ts-nocheck
      ;(() => {
        if (window.clarity) return
        const clarity = function () {
          clarity.q = clarity.q || []
          clarity.q.push(Array.from(arguments))
        }
        window.clarity = clarity
        const script = document.createElement('script')
        script.async = true
        script.src = 'https://www.clarity.ms/tag/rkga1fxqqs'
        const firstScript = document.getElementsByTagName('script')[0]
        if (firstScript?.parentNode) {
          firstScript.parentNode.insertBefore(script, firstScript)
        } else {
          document.head.appendChild(script)
        }
      })()
    </script>
    <script is:inline>
      // 主题初始化 - 防止页面加载闪烁
      (function() {
        const applyTheme = () => {
          const stored = localStorage.getItem('theme');
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme = stored || (prefersDark ? 'dark' : 'light');
          document.documentElement.classList.toggle('dark', theme === 'dark');
        };
        applyTheme();
        window.__applyTheme = applyTheme;
      })();
    </script>
    <script is:inline>
      // 主题切换按钮（无水合也可用）
      (function() {
        if (window.__themeToggleBound) return;
        window.__themeToggleBound = true;
        const toggleTheme = () => {
          const isDark = document.documentElement.classList.contains('dark');
          const next = isDark ? 'light' : 'dark';
          localStorage.setItem('theme', next);
          document.documentElement.classList.toggle('dark', next === 'dark');
        };
        window.__toggleTheme = toggleTheme;
        document.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;
          const button = target.closest('[data-theme-toggle]');
          if (!button) return;
          event.preventDefault();
          toggleTheme();
        });
      })();
    </script>
    <script is:inline>
      // 预过滤标记：避免带 tag/category 查询的首页渲染闪动
      (function() {
        try {
          const params = new URLSearchParams(window.location.search);
          if (params.has("category") || params.has("tag")) {
            document.documentElement.setAttribute("data-prefilter", "1");
          }
        } catch {}
      })();
    </script>
    <ViewTransitions />
  </head>
  <body class="bg-background text-foreground">
    <slot />
    <script is:inline>
      // View Transitions 页面切换后重应用主题
      (function() {
        const applyTheme = window.__applyTheme
        if (typeof applyTheme !== "function") return
        document.addEventListener("astro:page-load", applyTheme)
        document.addEventListener("astro:after-swap", applyTheme)
        window.addEventListener("pageshow", applyTheme)
      })()
    </script>
    <script is:inline>
      // Copy button functionality for Expressive Code
      function initCopyButtons() {
        document.querySelectorAll('.expressive-code .copy-btn').forEach(function(btn) {
          if (btn.dataset.initialized) return;
          btn.dataset.initialized = 'true';
          btn.addEventListener('click', async function() {
            const pre = btn.closest('pre');
            if (!pre) return;
            const code = pre.querySelector('code');
            if (!code) return;
            // 只提取 .code 元素的内容，排除行号 (.gutter)
            const lines = code.querySelectorAll('.ec-line .code');
            const text = Array.from(lines).map(function(line) {
              return line.textContent || '';
            }).join('\n');
            try {
              await navigator.clipboard.writeText(text);
              btn.classList.add('copied');
              setTimeout(function() {
                btn.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });
        });
      }
      document.addEventListener('DOMContentLoaded', initCopyButtons);
      document.addEventListener('astro:page-load', initCopyButtons);
    </script>
    <script is:inline data-astro-rerun>
      // GitHub card loader fallback (view transitions safe)
      (function() {
        const debugEnabled = () => localStorage.getItem("debugGithubCard") === "1"
        const debug = (...args) => {
          if (debugEnabled()) console.log("[GITHUB-CARD]", ...args)
        }
        const __gcLangColorsMap = {
          JavaScript: "#f1e05a",
          TypeScript: "#3178c6",
          Python: "#3572A5",
          Java: "#b07219",
          "C++": "#f34b7d",
          C: "#555555",
          "C#": "#178600",
          Go: "#00ADD8",
          Rust: "#dea584",
          Ruby: "#701516",
          PHP: "#4F5D95",
          Swift: "#F05138",
          Kotlin: "#A97BFF",
          Dart: "#00B4AB",
          Scala: "#c22d40",
          Shell: "#89e051",
          HTML: "#e34c26",
          CSS: "#563d7c",
          SCSS: "#c6538c",
          Vue: "#41b883",
          Svelte: "#ff3e00",
          Astro: "#ff5a03",
          MDX: "#fcb32c",
          Markdown: "#083fa1",
          JSON: "#292929",
          YAML: "#cb171e",
          Dockerfile: "#384d54",
          Makefile: "#427819",
          Lua: "#000080",
          Perl: "#0298c3",
          R: "#198CE7",
          Julia: "#a270ba",
          Haskell: "#5e5086",
          Elixir: "#6e4a7e",
          Clojure: "#db5855",
          Objective_C: "#438eff",
          "Objective-C": "#438eff",
          Jupyter_Notebook: "#DA5B0B",
          "Jupyter Notebook": "#DA5B0B",
          Vim_Script: "#199f4b",
          TeX: "#3D6117",
          PowerShell: "#012456",
        }

        const formatNumber = (value) => {
          return Intl.NumberFormat("en-us", { notation: "compact", maximumFractionDigits: 1 })
            .format(value)
            .replaceAll("\u202f", "")
        }

        const initGithubCards = (source = "unknown") => {
          const cards = Array.from(document.querySelectorAll("[data-github-card][data-github-repo]"))
          debug("init", source, "cards:", cards.length)
          cards.forEach((card) => {
            if (!(card instanceof HTMLElement)) return
            if (card.dataset.githubLoaded === "true") return
            const repo = card.dataset.githubRepo
            if (!repo) return
            card.dataset.githubLoaded = "loading"
            debug("fetch", repo)

            fetch(`https://api.github.com/repos/${repo}`, { referrerPolicy: "no-referrer" })
              .then((response) => response.json())
              .then((data) => {
                const descEl = card.querySelector(".gc-description")
                if (descEl) {
                  descEl.textContent =
                    data.description?.replace(/:[a-zA-Z0-9_]+:/g, "") || "No description provided"
                }

                const langEl = card.querySelector(".gc-language")
                const lang = data.language || ""
                if (langEl) {
                  langEl.textContent = lang || "—"
                  if (lang && __gcLangColorsMap[lang]) {
                    langEl.style.setProperty("--gc-lang-color", __gcLangColorsMap[lang])
                  }
                }

                const forksEl = card.querySelector(".gc-forks")
                if (forksEl) forksEl.textContent = formatNumber(data.forks || 0)

                const starsEl = card.querySelector(".gc-stars")
                if (starsEl) starsEl.textContent = formatNumber(data.stargazers_count || 0)

                const licenseEl = card.querySelector(".gc-license")
                if (licenseEl) licenseEl.textContent = data.license?.spdx_id || "—"

                const avatarEl = card.querySelector(".gc-avatar")
                if (avatarEl && data.owner?.avatar_url) {
                  avatarEl.style.backgroundImage = `url(${data.owner.avatar_url})`
                  avatarEl.style.backgroundColor = "transparent"
                }

                card.classList.remove("fetch-waiting")
                card.dataset.githubLoaded = "true"
                debug("loaded", repo)
              })
              .catch(() => {
                card.classList.add("fetch-error")
                card.dataset.githubLoaded = "error"
                debug("error", repo)
              })
          })
        }

        document.addEventListener("DOMContentLoaded", () => initGithubCards("dom"))
        document.addEventListener("astro:page-load", () => initGithubCards("page-load"))
        document.addEventListener("astro:after-swap", () => initGithubCards("after-swap"))
        window.addEventListener("pageshow", () => initGithubCards("pageshow"))
        window.__initGithubCards = initGithubCards
      })()
    </script>
  </body>
</html>
